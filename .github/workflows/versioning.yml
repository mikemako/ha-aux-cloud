name: Update Version

on:
  push:
    tags:
      - 'v*'  # Trigger on tags starting with 'v'

jobs:
  update-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "TAG_REF=refs/tags/v${VERSION}" >> $GITHUB_ENV

      - name: Update manifest.json version
        run: |
          sed -i 's/"version": "[^"]*"/"version": "${{ env.VERSION }}"/' custom_components/aux_cloud/manifest.json
          
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git config --global --add safe.directory /github/workspace

      - name: Commit and push version update
        run: |
          # Get the branch name from the tag that triggered the workflow
          BRANCH_NAME=$(git show-ref --tags | grep $(git rev-parse HEAD) | grep -v "refs/tags/" | head -1 | sed 's/.*\///')
          
          # If no branch found, use the default branch
          if [ -z "$BRANCH_NAME" ]; then
            BRANCH_NAME=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          fi
          
          # Fetch the branch
          git fetch origin $BRANCH_NAME
          
          # Create a new branch at the current commit
          git checkout -b temp-branch
          
          # Stage and commit the manifest change
          git add custom_components/aux_cloud/manifest.json
          git commit -m "Bump version to ${{ env.VERSION }}"
          
          # Push the change to the original branch
          git push origin HEAD:$BRANCH_NAME
          
          # Clean up
          git checkout ${{ github.ref }}
          git branch -D temp-branch